**Архитектура библиотеки**

Классы фреймворка LLVM специально разработаны для достижения высоких характеристик быстродействия
и малых накладных расходов с точки зрения занимаемой памяти в процессе компиляции. Для разработки прототипов инструментов анализа программ в форме представления LLVM IR на языке Python такие жесткие требования не являются обязательными. Важным требованием при проектировании библиотеки llvm2py является обеспечение простоты взаимодействия со структурами данных подмножества LLVM IR за счёт использования базовых типов данных, встроенных в язык Python

На язык LLVM IR, в отличие от MLIR [@mlir2020], отсутствует формальная спецификация [@llvmlang]. В то же время, синтаксис LLVM IR меняется с выходом новых версий фреймворка LLVM. По этой причине воссоздание формальной
грамматики по программному коду LLVM не представляется целесообразным

В связи со сказанным выше, к проектируемой библиотеке выдвинуты следующие требования:

1. Простота предоставляемого пользователю библиотеки программного интерфейса.
2. Независимость кода библиотеки от изменений в синтаксисе языка LLVM IR.

Концептуальная схема взаимодействия с библиотекой изображена на @fig:make1. Как видно из рисунка, разработанная библиотека состоит из двух модулей, написанных на языках Python и C++ соответственно. Инструмент
пользователя, осуществляющий анализ программы в представлении LLVM IR, взаимодействует с разработанной
библиотекой llvm2py через программный интерфейс модуля библиотеки на Python. Инструмент пользователя
формирует некоторый результат анализа или синтеза кода. Модуль библиотеки на C++ взаимодействует с компонентами фреймворка LLVM, в которых содержится синтаксический анализатор и классы представления LLVM
IR, а также реализует функциональность преобразования текста LLVM IR в объекты Python.

Таким образом, библиотека llvm2py использует готовый код реализации синтаксического разбора LLVM IR
из фреймворка LLVM. Этим обеспечивается независимость llvm2py от изменений в синтаксисе языка LLVM IR:
изменения в языке LLVM IR приводят лишь к перекомпиляции кода llvm2py с возможными незначительными
изменениями в программном интерфейсе взаимодействия с библиотекой LLVM. Простота программного интерфейса разработанной библиотеки достигается за счёт представления подмножества LLVM IR с помощью небольшого числа классов и встроенных типов данных языка Python.

Благодаря статическому связыванию библиотеки с компонентами LLVM, библиотека является независимой
от фреймворка LLVM, а ее размер, на момент написания этой статьи, не превышает 8 Мбайт в скомпилированном
виде

![Концептуальная схема взаимодействия с библиотекой](./images/png1.png){#fig:make1 width=6.5in}

**Модуль на Python**

Данный модуль содержит подмножество классов LLVM, описывающих представление LLVM IR (@fig:make2).
Изображённый на @fig:make2 набор классов не отражает LLVM IR полностью, но позволяет решать многие задачи
анализа кода, поскольку реализует основные элементы языка LLVM IR. Библиотека llvm2py спроектирована с
возможностью расширения для решения задач, требующих более полной поддержки LLVM IR

Программу в иерархии, показанной на @fig:make2, представляет класс с названием Module, который содержит в
себе множество функций (класс Function). Тело функции содержит линейные участки (Block), которые, в свою
очередь, содержат команды (Instruction). Все классы, за исключением класса Module, наследуются от класса
Value, тем самым, переиспользуя такие поля, как тип (Type) и имя. Типы и коды операций команд представляются
классами перечислений (TypeID и Opcode).

Рассматриваемый Python-модуль библиотеки предоставляет пользователю следующий программный интерфейс:

1. Функция parse_assembly, преобразующая LLVM IR из текстового вида в объекты Python.
2. Функция dump, осуществляющая отладочный вывод представления в виде объектов Python в текстовой
форме.
3. Иерархиция классов, показанная на @fig:make2 и реализующая подмножество классов LLVM IR.
4. Ряд вспомогательных классов-перечислений, необходимых для работы с перечислимыми полями классов,
такими как коды операций команд.

**Модуль на C++**

Данный модуль содержит реализацию функции parse_assembly, которая преобразует текст LLVM IR в объекты Python. Для реализации этой функции необходима возможность создания объектов Python из модуля на
C++. Такую возможность, как и возможность создания расширения C++ для Python предоставляет, используемый
в llvm2py, инструмент pybind11

В рамках работы функции parse_assembly выполняется разбор текста LLVM IR за счёт функциональности
средств синтаксического разбора, импортированных из фреймворка LLVM, после чего, c помощью одного обхода иерархии объектов LLVM IR на C++, выполняется создание объектов Python на основе данных из объектов
C++. В результате возвращается полученное представление подмножества LLVM IR в виде объектов Python.

![Диаграмма подмножества классов представления LLVM IR в llvm2py](./images/png2.png){#fig:make2 width="6.5in"}